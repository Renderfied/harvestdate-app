<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HarvestDate - Local Fresh Food Marketplace</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-email {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .auth-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .auth-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .search-container {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 1px solid #e2e8f0;
        }

        .search-form {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #22c55e;
        }

        .search-btn, .add-listing-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-btn:hover, .add-listing-btn:hover {
            background: #16a34a;
        }

        .main-content {
            display: flex;
            height: calc(100vh - 140px);
        }

        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 1.1rem;
        }

        .listing-card {
            border-bottom: 1px solid #e2e8f0;
            padding: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .listing-card:hover {
            background: #f8fafc;
        }

        .listing-owner {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #22c55e;
            color: white;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .listing-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .listing-details {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .listing-price {
            font-weight: 700;
            color: #22c55e;
            font-size: 1.1rem;
        }

        .listing-distance {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #22c55e;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            background: #22c55e;
            color: white;
            border: none;
            padding: 0.875rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .submit-btn:hover {
            background: #16a34a;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1rem;
            color: #6b7280;
        }

        .auth-switch a {
            color: #22c55e;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .success-message {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .auth-required {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .auth-required button {
            background: #22c55e;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 250px;
            }
            
            .map-container {
                flex: 1;
                min-height: 300px;
            }
            
            .search-form {
                flex-direction: column;
            }
            
            .search-input {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1>🥬 HarvestDate</h1>
            <p>Find fresh, local produce directly from growers in your area</p>
        </div>
        <div class="header-right" id="headerAuth">
            <!-- Auth content will be populated here -->
        </div>
    </header>

    <div class="search-container">
        <div class="search-form">
            <input type="text" class="search-input" id="searchInput" placeholder="Search for tomatoes, apples, herbs...">
            <button class="search-btn" onclick="searchProducts()">Search</button>
            <button class="add-listing-btn" id="addListingBtn" onclick="checkAuthAndAddListing()">+ Add Listing</button>
        </div>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Available Products</h3>
                <span id="resultCount">0 items</span>
            </div>
            <div id="listingsList">
                <!-- Products will be populated here -->
            </div>
        </div>

        <div class="map-container">
            <div id="map">
                <div>📍 Interactive Map Loading...</div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="authModalTitle">Welcome to HarvestDate</h2>
                <button class="close-btn" onclick="closeAuthModal()">&times;</button>
            </div>
            
            <div id="authError" class="error-message" style="display: none;"></div>
            <div id="authSuccess" class="success-message" style="display: none;"></div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form id="loginFormElement">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" required>
                    </div>
                    
                    <button type="submit" class="submit-btn">Sign In</button>
                </form>
                
                <div class="auth-switch">
                    Don't have an account? <a href="#" onclick="showRegisterForm()">Sign up here</a>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <form id="registerFormElement">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="registerName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="registerEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="registerPassword" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Location (City, State)</label>
                        <input type="text" class="form-input" id="registerLocation" placeholder="e.g., Tacoma, WA" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-input" id="registerPhone" placeholder="(555) 123-4567">
                    </div>
                    
                    <button type="submit" class="submit-btn">Create Account</button>
                </form>
                
                <div class="auth-switch">
                    Already have an account? <a href="#" onclick="showLoginForm()">Sign in here</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Listing Modal -->
    <div id="addListingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Listing</h2>
                <button class="close-btn" onclick="closeAddListingModal()">&times;</button>
            </div>
            <form id="addListingForm">
                <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-input" id="productName" placeholder="e.g., Fresh Garden Tomatoes" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="category" required>
                        <option value="">Select category</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="fruits">Fruits</option>
                        <option value="herbs">Herbs</option>
                        <option value="grains">Grains</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="description" placeholder="Describe your product, growing methods, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Price</label>
                    <input type="text" class="form-input" id="price" placeholder="e.g., $3.50/lb or $15/box" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Harvest Date</label>
                    <input type="date" class="form-input" id="harvestDate" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Available Until</label>
                    <input type="date" class="form-input" id="availableUntil" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Location (Address or ZIP)</label>
                    <input type="text" class="form-input" id="location" placeholder="Enter your address or ZIP code" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Contact Method</label>
                    <input type="text" class="form-input" id="contact" placeholder="Phone number or email" required>
                </div>
                
                <button type="submit" class="submit-btn">Add Listing</button>
            </form>
        </div>
    </div>

    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://bgyoonkfzrjbiypgliom.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJneW9vbmtmenJqYml5cGdsaWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyNzE4OTYsImV4cCI6MjA2NTg0Nzg5Nn0.xi_zPeMAnHQZ4BF6BUa-1_nYCzajtRZL1gyS1ZePUAI';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let map;
        let markers = [];
        let filteredProducts = [];
        let mapsLoaded = false;
        let currentUser = null;

        // Sample data for demonstration (will be replaced with database data)
        let products = [
            {
                id: 1,
                name: "Organic Cherry Tomatoes",
                category: "vegetables",
                description: "Sweet, vine-ripened cherry tomatoes grown without pesticides",
                price: "$4.50/lb",
                harvestDate: "2025-08-15",
                availableUntil: "2025-09-30",
                location: "Tacoma, WA",
                contact: "555-0123",
                lat: 47.2529,
                lng: -122.4443,
                userId: "demo-user-1",
                userName: "Demo Farmer"
            },
            {
                id: 2,
                name: "Fresh Basil",
                category: "herbs",
                description: "Aromatic sweet basil, perfect for cooking",
                price: "$2.00/bunch",
                harvestDate: "2025-07-20",
                availableUntil: "2025-10-15",
                location: "Puyallup, WA",
                contact: "555-0456",
                lat: 47.1856,
                lng: -122.3126,
                userId: "demo-user-2",
                userName: "Herb Garden Co"
            },
            {
                id: 3,
                name: "Honeycrisp Apples",
                category: "fruits",
                description: "Crisp, sweet apples from our family orchard",
                price: "$3.25/lb",
                harvestDate: "2025-09-10",
                availableUntil: "2025-12-01",
                location: "Auburn, WA",
                contact: "555-0789",
                lat: 47.3073,
                lng: -122.2284,
                userId: "demo-user-3",
                userName: "Valley Orchards"
            }
        ];

        // Initialize the app
        async function initApp() {
            // Check for existing session
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                updateAuthUI();
            }

            // Listen for auth changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    updateAuthUI();
                    closeAuthModal();
                    showSuccess('Welcome to HarvestDate!');
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    updateAuthUI();
                }
            });

            filteredProducts = products;
            updateSidebar(products);
            updateAuthUI();
            
            // Try to load Google Maps
            if (typeof google !== 'undefined' && google.maps) {
                initGoogleMaps();
            } else {
                // Fallback: show a simple placeholder map
                initPlaceholderMap();
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            const headerAuth = document.getElementById('headerAuth');
            
            if (currentUser) {
                headerAuth.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">Welcome, ${currentUser.user_metadata?.full_name || currentUser.email}</div>
                        <div class="user-email">${currentUser.email}</div>
                    </div>
                    <button class="auth-btn" onclick="signOut()">Sign Out</button>
                `;
            } else {
                headerAuth.innerHTML = `
                    <button class="auth-btn" onclick="openAuthModal('login')">Sign In</button>
                    <button class="auth-btn" onclick="openAuthModal('register')">Sign Up</button>
                `;
            }
        }

        // Authentication functions
        function openAuthModal(mode = 'login') {
            document.getElementById('authModal').style.display = 'block';
            if (mode === 'register') {
                showRegisterForm();
            } else {
                showLoginForm();
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearAuthMessages();
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('authModalTitle').textContent = 'Sign In';
            clearAuthMessages();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('authModalTitle').textContent = 'Create Account';
            clearAuthMessages();
        }

        function clearAuthMessages() {
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('authSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        // Login form handler
        document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAuthMessages();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                showError(error.message);
            }
        });

        // Register form handler
        document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAuthMessages();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const location = document.getElementById('registerLocation').value;
            const phone = document.getElementById('registerPhone').value;
            
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: name,
                        location: location,
                        phone: phone
                    }
                }
            });
            
            if (error) {
                showError(error.message);
            } else {
                showSuccess('Account created successfully! Please sign in.');
                setTimeout(() => showLoginForm(), 2000);
            }
        });

        // Sign out function
        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error signing out:', error);
            }
        }

        // Check authentication before adding listing
        function checkAuthAndAddListing() {
            if (!currentUser) {
                openAuthModal('login');
                return;
            }
            openAddListingModal();
        }

        function initPlaceholderMap() {
            const mapElement = document.getElementById('map');
            mapElement.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Google Maps Loading...</div>
                    <div style="font-size: 0.9rem; color: #6b7280;">Billing enabled - maps should appear shortly</div>
                    <button onclick="location.reload()" style="background: #22c55e; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; margin-top: 1rem; font-weight: 600;">Refresh to Load Maps</button>
                </div>
            `;
        }

        // Initialize Google Maps (when available)
        function initGoogleMaps() {
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 47.2529, lng: -122.4443 },
                    zoom: 10,
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_CENTER
                    },
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                        position: google.maps.ControlPosition.TOP_CENTER
                    },
                    scaleControl: true,
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    fullscreenControl: true,
                    gestureHandling: 'greedy',
                    minZoom: 3,
                    maxZoom: 18
                });
                mapsLoaded = true;
                displayProductsOnMap(products);
            } catch (error) {
                console.log('Google Maps not available:', error);
                initPlaceholderMap();
            }
        }

        // Display products on Google Maps
        function displayProductsOnMap(productsToShow) {
            if (!mapsLoaded) return;

            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Add new markers
            productsToShow.forEach(product => {
                const marker = new google.maps.Marker({
                    position: { lat: product.lat, lng: product.lng },
                    map: map,
                    title: product.name
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 8px; max-width: 250px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${product.name}</div>
                            <div style="margin-bottom: 8px;">${product.description}</div>
                            <div style="color: #22c55e; font-weight: 700; font-size: 1.1em;">${product.price}</div>
                            <div style="font-size: 0.8em; color: #666; margin-top: 8px;">
                                Harvest: ${formatDate(product.harvestDate)}<br>
                                Seller: ${product.userName}<br>
                                Contact: ${product.contact}
                            </div>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });
        }

        // Update sidebar with product list
        function updateSidebar(productsToShow) {
            const listingsList = document.getElementById('listingsList');
            const resultCount = document.getElementById('resultCount');
            
            resultCount.textContent = `${productsToShow.length} items`;

            if (productsToShow.length === 0) {
                listingsList.innerHTML = '<div class="empty-state"><p>No products found. Try a different search term.</p></div>';
                return;
            }

            listingsList.innerHTML = productsToShow.map(product => `
                <div class="listing-card" onclick="focusOnProduct(${product.id})">
                    ${product.userId === currentUser?.id ? '<div class="listing-owner">Your Listing</div>' : ''}
                    <div class="listing-title">${product.name}</div>
                    <div class="listing-details">${product.description}</div>
                    <div class="listing-price">${product.price}</div>
                    <div class="listing-distance">📍 ${product.location} • Harvest: ${formatDate(product.harvestDate)} • By: ${product.userName}</div>
                </div>
            `).join('');
        }

        // Focus map on specific product
        function focusOnProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product && mapsLoaded) {
                map.setCenter({ lat: product.lat, lng: product.lng });
                map.setZoom(14);
                
                const marker = markers.find(m => {
                    const pos = m.getPosition();
                    return pos.lat() === product.lat && pos.lng() === product.lng;
                });
                
                if (marker) {
                    google.maps.event.trigger(marker, 'click');
                }
            }
        }

        // Search functionality
        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                filteredProducts = products;
            } else {
                filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm) ||
                    product.description.toLowerCase().includes(searchTerm)
                );
            }
            
            updateSidebar(filteredProducts);
            if (mapsLoaded) {
                displayProductsOnMap(filteredProducts);
            }
        }

        // Modal functions
        function openAddListingModal() {
            document.getElementById('addListingModal').style.display = 'block';
        }

        function closeAddListingModal() {
            document.getElementById('addListingModal').style.display = 'none';
            document.getElementById('addListingForm').reset();
        }

        // Add new listing
        document.getElementById('addListingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentUser) {
                alert('Please sign in to add a listing.');
                return;
            }
            
            const formData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                price: document.getElementById('price').value,
                harvestDate: document.getElementById('harvestDate').value,
                availableUntil: document.getElementById('availableUntil').value,
                location: document.getElementById('location').value,
                contact: document.getElementById('contact').value
            };

            // For demo, add with approximate coordinates near Tacoma
            const newProduct = {
                id: products.length + 1,
                ...formData,
                lat: 47.2529 + (Math.random() - 0.5) * 0.2,
                lng: -122.4443 + (Math.random() - 0.5) * 0.2,
                userId: currentUser.id,
                userName: currentUser.user_metadata?.full_name || currentUser.email
            };

            products.push(newProduct);
            updateSidebar(products);
            if (mapsLoaded) {
                displayProductsOnMap(products);
            }
            closeAddListingModal();
            
            alert('Listing added successfully! 🎉');
        });

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        // Handle search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const authModal = document.getElementById('authModal');
            const addListingModal = document.getElementById('addListingModal');
            
            if (e.target === authModal) {
                closeAuthModal();
            }
            if (e.target === addListingModal) {
                closeAddListingModal();
            }
        });

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', initApp);

        // Global function for Google Maps callback (when available)
        window.initMap = function() {
            initGoogleMaps();
        };
    </script>

    <!-- Load Google Maps API (will gracefully fail if billing not enabled) -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD0v1wZzknlcQyUkcZHqcCLSbMUfGXUkag&libraries=places&callback=initMap"
        onerror="console.log('Google Maps failed to load - billing may need to be enabled')">
    </script>
</body>
</html>
